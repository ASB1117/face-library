<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>School Library Management System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --primary-color: #4CAF50; /* Light Green */
            --primary-hover: #45a049;
            --background-color: #f5f5f5;
            --container-bg: #fff;
            --header-bg: #e8f5e9; /* Lighter green for header */
            --text-color: #333;
            --border-color: #ddd;
            --danger-color: #e74c3c;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--background-color); color: var(--text-color); }
        header { background: var(--header-bg); color: var(--text-color); padding: 15px 20px; text-align: center; border-bottom: 2px solid var(--primary-color); }
        header h1 { margin: 0; font-size: 24px; font-weight: 600; }
        .container { max-width: 1200px; margin: 25px auto; background: var(--container-bg);
                     padding: 20px 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                     border-radius: 8px; }
        .tabs { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .tab-btn { flex: 1; min-width: 180px; padding: 12px 15px; border: none; cursor: pointer;
                    background: #f0f0f0; border-radius: 6px; font-weight: bold; font-size: 14px;
                    transition: background-color 0.3s, color 0.3s; }
        .tab-btn:hover:not(.active) { background: #e0e0e0; }
        .tab-btn.active { background: var(--primary-color); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        h2, h3 { color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 20px; }
        label { display: block; margin: 8px 0 4px; font-size: 14px; font-weight: 500; }
        input[type="text"], input[type="number"], input[type="date"], input[type="password"], select, input[type="file"] {
            width: 100%; padding: 8px 10px; margin-bottom: 15px; box-sizing: border-box;
            border-radius: 4px; border: 1px solid var(--border-color); font-size: 14px;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, input[type="password"]:focus, select:focus {
            border-color: var(--primary-color); outline: none;
        }
        .row { display: flex; gap: 20px; flex-wrap: wrap; }
        .col-3 { flex: 1 1 30%; min-width: 250px; }
        button { padding: 10px 18px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600;
                  transition: background-color 0.3s; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-danger:hover { background: #c0392b; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th, td { border: 1px solid var(--border-color); padding: 8px 10px; text-align: left; vertical-align: middle; }
        th { background: #f0f0f0; }
        .small { font-size: 12px; color: #777; }
        .message { margin-top: 10px; padding: 10px; border-radius: 4px; font-size: 14px; background: #e8f5e9; color: var(--primary-color); }
        .error { background: #ffe0e0; color: var(--danger-color); }
        .badge { display: inline-block; padding: 4px 8px; font-size: 12px; border-radius: 12px;
                 background: var(--primary-color); color: #fff; font-weight: bold; }
        .top-info { display: flex; justify-content: flex-start; flex-wrap: wrap; gap: 20px;
                    font-size: 14px; margin-bottom: 15px; }
        hr { border: none; border-top: 1px solid var(--border-color); margin: 25px 0; }
        .btn-print { margin-top: 10px; }
        .see-more-btn { margin-top: 10px; font-size: 13px; padding: 8px 15px; }

        /* Modal Styles for Book Details */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888;
            width: 80%; max-width: 600px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-btn {
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
        }
        .close-btn:hover, .close-btn:focus {
            color: #000; text-decoration: none; cursor: pointer;
        }
        .book-detail-table { width: 100%; margin-top: 15px; }
        .book-detail-table td:first-child { width: 30%; font-weight: bold; }
        .book-detail-table td { padding: 8px 0; border-bottom: 1px dotted #ccc; }
    </style>
</head>
<body>
    <header>
        <h1>School Library Management System</h1>
        <div class="sub">Search &amp; Manage Books ‚Ä¢ Issue &amp; Return Records</div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" data-tab="searchTab"><span class="icon">üîç</span> Search Books</button>
            <button class="tab-btn" data-tab="adminTab"><span class="icon">‚öôÔ∏è</span> Admin Panel</button>
            <button class="tab-btn" data-tab="reportsTab"><span class="icon">üìä</span> Reports</button>
        </div>

        <div id="searchTab" class="tab-content active">
            <h2>Book Search &amp; Availability</h2>
            <div class="top-info">
                <div>Total Books: <span id="totalCount" class="badge">0</span></div>
                <div>Showing: <span id="shownCount" class="badge">0</span></div>
            </div>

            <div class="row">
                <div class="col-3">
                    <label for="searchText">Search (Title / Author / Book ID / Category)</label>
                    <input type="text" id="searchText" placeholder="Type any word..." />
                </div>
                <div class="col-3">
                    <label for="categoryFilter">Category</label>
                    <select id="categoryFilter">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="col-3">
                    <label>&nbsp;</label>
                    <button class="btn-primary" id="clearFilters"><span class="icon">üßπ</span> Clear Filters</button>
                </div>
            </div>

            <table id="booksTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Book ID</th>
                        <th>Title</th>
                        <th>Author</th>
                        <th>Category</th>
                        <th>Source</th>
                        <th>Details</th> </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div id="adminTab" class="tab-content">
            <h2>Admin Panel</h2>

            <div id="loginSection">
                <label for="adminPassword">Admin Password</label>
                <input type="password" id="adminPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                <button class="btn-primary" id="loginBtn"><span class="icon">üîë</span> Login</button>
                <div id="loginMsg" class="message error"></div>
            </div>

            <div id="adminSection" style="display:none; margin-top:20px;">
                <h3><span class="icon">üìö</span> Issue Book</h3>
                <p class="small">
                    Type only <strong>Book ID</strong> and <strong>Student ID</strong>. Book Title and Student Name will fill automatically.
                </p>
                <div class="row">
                    <div class="col-3">
                        <label for="issueBookNo">Book ID</label>
                        <input type="text" id="issueBookNo" placeholder="e.g. N-1/750" />
                        <div class="small">After typing, press <strong>Tab</strong> or click outside to auto-fill book title.</div>
                    </div>
                    <div class="col-3">
                        <label for="issueBookTitle">Book Title (auto)</label>
                        <input type="text" id="issueBookTitle" placeholder="Auto from Book ID" readonly />
                    </div>
                    <div class="col-3">
                        <label for="studentId">Student ID (Library Code)</label>
                        <input type="text" id="studentId" placeholder="e.g. B7" />
                        <div class="small">After typing, press <strong>Tab</strong> or click outside to auto-fill name.</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-3">
                        <label for="studentName">Student Name (auto)</label>
                        <input type="text" id="studentName" placeholder="Auto from Student ID" readonly />
                    </div>
                    <div class="col-3">
                        <label for="classSection">Class &amp; Division</label>
                        <input type="text" id="classSection" placeholder="e.g. 7A, 8B" />
                    </div>
                    <div class="col-3">
                        <label for="issueDate">Issue Date</label>
                        <input type="date" id="issueDate" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-3">
                        <label for="dueDate">Due Date (3 weeks)</label>
                        <input type="date" id="dueDate" />
                    </div>
                </div>

                <button class="btn-primary" id="issueBookBtn"><span class="icon">‚û°Ô∏è</span> Issue Book</button>
                <div id="issueMsg" class="message"></div>

                <hr>

                <h3><span class="icon">üîÑ</span> Issue / Return Records (Search by Student ID or Name)</h3>
                <div class="row">
                    <div class="col-3"><input type="text" id="issueSearch" placeholder="Student ID or Name..." /></div>
                </div>
                
                <table id="issueTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Class</th>
                            <th>Book ID</th>
                            <th>Title</th>
                            <th>Issue Date</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button class="btn-primary see-more-btn" id="issueSeeMoreBtn" style="display:none;">See more‚Ä¶</button>

                <hr>

                <h3><span class="icon">‚ûï</span> Manually Add New Book</h3>
                <div class="row">
                    <div class="col-3">
                        <label for="adminBookNo">Book ID</label>
                        <input type="text" id="adminBookNo" placeholder="e.g. N-1/750" />
                    </div>
                    <div class="col-3">
                        <label for="adminTitle">Title</label>
                        <input type="text" id="adminTitle" placeholder="Book title" />
                    </div>
                    <div class="col-3">
                        <label for="adminAuthor">Author</label>
                        <input type="text" id="adminAuthor" placeholder="Author name" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-3">
                        <label for="adminCategory">Category</label>
                        <input type="text" id="adminCategory" placeholder="e.g. Novel, Story..." />
                    </div>
                </div>
                <button class="btn-primary" id="addBookBtn"><span class="icon">üíæ</span> Add Book</button>
                <div id="adminMsg" class="message"></div>

                <hr>

                <h3><span class="icon">üìã</span> Locally Added Books</h3>
                <table id="extraTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Book ID</th>
                            <th>Title</th>
                            <th>Author</th>
                            <th>Category</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button class="btn-primary see-more-btn" id="extraSeeMoreBtn" style="display:none;">See more‚Ä¶</button>
            </div>
        </div>
        
        <div id="reportsTab" class="tab-content">
            <h2>Reporting &amp; Data Management</h2>
            
            <div id="reportLoginSection">
                <p class="small">Admin access is required for reports and data imports.</p>
                <button class="btn-primary" onclick="document.querySelector('.tab-btn[data-tab=\'adminTab\']').click();">Go to Admin Login</button>
            </div>
            
            <div id="reportSection" style="display:none;">
                <h3><span class="icon">‚ö†Ô∏è</span> Overdue Books Report</h3>
                <p class="small">Generate and print a list of all currently overdue books.</p>
                <button class="btn-primary btn-print" id="printOverdueBtn"><span class="icon">üñ®</span> Print Overdue Report</button>
                
                <hr>

                <h3><span class="icon">üì•</span> Import Books Excel (.xlsx)</h3>
                <p class="small">
                    Excel must have Book ID &amp; Book Name columns (e.g., BOOK NO, TITLE). Imported books are added to the local list.
                </p>
                <div class="row">
                    <div class="col-3"><input type="file" id="excelFile" accept=".xlsx,.xls" /></div>
                    <div class="col-3"><button class="btn-primary" id="importExcelBtn"><span class="icon">‚¨ÜÔ∏è</span> Import Books</button></div>
                </div>
                <div id="importMsg" class="message"></div>

                <hr>

                <h3><span class="icon">üë§</span> Import Student IDs Excel (.xlsx)</h3>
                <p class="small">
                    Use your student ID list here. **Column A** = Library Code (e.g., B7), **Column B** = Student Name. This data is used for auto-fill during issue.
                </p>
                <div class="row">
                    <div class="col-3"><input type="file" id="studentExcelFile" accept=".xlsx,.xls" /></div>
                    <div class="col-3"><button class="btn-primary" id="importStudentsBtn"><span class="icon">üë•</span> Import Student IDs</button></div>
                </div>
                <div id="studentImportMsg" class="message"></div>
                
                <hr>
                
                <h3><span class="icon">üì§</span> Export All Data</h3>
                <p class="small">Export all current book data (Base + Local) and Issue Records to Excel for backup.</p>
                <div class="row">
                    <div class="col-3"><button class="btn-primary" id="exportAllBooksBtn"><span class="icon">‚¨áÔ∏è</span> Export All Books</button></div>
                    <div class="col-3"><button class="btn-primary" id="exportIssuesBtn"><span class="icon">‚¨áÔ∏è</span> Export Issue Records</button></div>
                </div>
            </div>
        </div>
    </div>

    <div id="bookDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3>Book Details &amp; History</h3>
            <table class="book-detail-table">
                <tr><td>Title</td><td id="modalTitle"></td></tr>
                <tr><td>Book ID</td><td id="modalBookNo"></td></tr>
                <tr><td>Author</td><td id="modalAuthor"></td></tr>
                <tr><td>Category</td><td id="modalCategory"></td></tr>
                <tr><td>Source</td><td id="modalSource"></td></tr>
            </table>
            
            <h4>Issue History</h4>
            <table id="modalIssueHistory">
                <thead><tr><th>Student ID</th><th>Name</th><th>Issue Date</th><th>Due Date</th><th>Status</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        window.baseBooks = [
            { serialNo: "1", bookNo: "N-1/001", title: "The Little Prince", author: "Antoine de Saint-Exup√©ry", category: "Novel" },
            { serialNo: "2", bookNo: "N-1/002", title: "Twenty Thousand Leagues Under the Sea", author: "Jules Verne", category: "Science Fiction" },
            { serialNo: "3", bookNo: "N-1/003", title: "The Old Man and the Sea", author: "Ernest Hemingway", category: "Novel" },
            { serialNo: "4", bookNo: "R-2/001", title: "World History Atlas", author: "Various", category: "Reference" },
            { serialNo: "5", bookNo: "R-2/002", title: "Complete English Grammar", author: "J. Smith", category: "Reference" },
            { serialNo: "6", bookNo: "S-3/001", title: "Animal Stories for Kids", author: "A. B. C. Writer", category: "Story Collection" }
        ];
    </script>
    <script>
        // Constants
        const ADMIN_PASSWORD = "FWLSLIB123";
        const LOCAL_KEY = "library_extra_books_v1";
        const ISSUE_KEY = "library_issues_v1";
        const STUDENTS_KEY = "library_students_v1";
        
        // Data Arrays
        let extraBooks = [];
        let allBooks = [];
        let issues = [];
        let students = [];
        let extraExpanded = false;
        let issuesExpanded = false;

        // Utility Functions
        function todayStr() {
            const d = new Date();
            return d.toISOString().slice(0, 10);
        }
        function addDays(dateStr, days) {
            const d = new Date(dateStr);
            d.setDate(d.getDate() + days);
            return d.toISOString().slice(0, 10);
        }
        function generateReceipt(issueItem) { // New Feature: Receipt Generation
            const win = window.open("", "_blank");
            if (!win) return;
            let html = "<html><head><title>Book Issue/Return Receipt</title>";
            html += "<style>body{font-family:Arial,sans-serif;font-size:14px;margin:30px;} h2,h3{text-align:center;} table{width:100%;border-collapse:collapse;} td{padding:8px;border:1px solid #ddd;}</style>";
            html += "</head><body>";
            html += "<h2>School Library</h2>";
            html += "<h3>Book " + (issueItem.status === "Returned" ? "Return" : "Issue") + " Receipt</h3>";
            html += "<p><strong>Date:</strong> " + todayStr() + "</p>";
            html += "<table>";
            html += "<tr><td>Transaction ID:</td><td>" + issueItem.id + "</td></tr>";
            html += "<tr><td>Student ID:</td><td>" + (issueItem.studentId || "") + "</td></tr>";
            html += "<tr><td>Student Name:</td><td>" + (issueItem.studentName || "") + "</td></tr>";
            html += "<tr><td>Class:</td><td>" + (issueItem.classSection || "") + "</td></tr>";
            html += "<tr><td>Book ID:</td><td>" + (issueItem.bookNo || "") + "</td></tr>";
            html += "<tr><td>Title:</td><td>" + (issueItem.title || "") + "</td></tr>";
            html += "<tr><td>Issue Date:</td><td>" + (issueItem.issueDate || "") + "</td></tr>";
            html += "<tr><td>Due Date:</td><td>" + (issueItem.dueDate || "") + "</td></tr>";
            if (issueItem.status === "Returned") {
                html += "<tr><td>Return Date:</td><td>" + (issueItem.returnDate || "") + "</td></tr>";
            }
            html += "<tr><td>Status:</td><td>" + (issueItem.status || "") + "</td></tr>";
            html += "</table>";
            html += "<p style='margin-top: 30px; text-align: center;'>Thank you! Please return the book on time.</p>";
            html += "</body></html>";
            
            win.document.open();
            win.document.write(html);
            win.document.close();
            win.focus();
            win.print();
        }

        // Data Management (Loading/Saving)
        function loadExtraBooks() {
            try { extraBooks = JSON.parse(localStorage.getItem(LOCAL_KEY)) || []; }
            catch(e) { extraBooks = []; }
        }
        function saveExtraBooks() { localStorage.setItem(LOCAL_KEY, JSON.stringify(extraBooks)); }

        function loadIssues() {
            try { issues = JSON.parse(localStorage.getItem(ISSUE_KEY)) || []; }
            catch(e) { issues = []; }
        }
        function saveIssues() { localStorage.setItem(ISSUE_KEY, JSON.stringify(issues)); }

        function loadStudents() {
            try { students = JSON.parse(localStorage.getItem(STUDENTS_KEY)) || []; }
            catch(e) { students = []; }
        }
        function saveStudents() { localStorage.setItem(STUDENTS_KEY, JSON.stringify(students)); }

        function combineBooks() {
            const baseWithType = (window.baseBooks || []).map(b => ({
                serialNo: b.serialNo || "",
                bookNo: b.bookNo || "",
                title: b.title || "",
                author: b.author || "",
                category: b.category || "",
                _type: "Base Excel"
            }));
            const extraWithType = extraBooks.map(b => ({ ...b, _type: "Locally Added" }));
            allBooks = baseWithType.concat(extraWithType);
            renderCategoryOptions();
        }

        // Rendering Functions
        function renderCategoryOptions() {
            const select = document.getElementById("categoryFilter");
            while (select.options.length > 1) select.remove(1);
            const categories = new Set();
            allBooks.forEach(b => {
                if (b.category && String(b.category).trim() !== "") {
                    categories.add(String(b.category).trim());
                }
            });
            Array.from(categories).sort().forEach(cat => {
                const opt = document.createElement("option");
                opt.value = cat; opt.textContent = cat; select.appendChild(opt);
            });
        }

        function renderBooksTable() {
            const tbody = document.querySelector("#booksTable tbody");
            tbody.innerHTML = "";
            const searchText = document.getElementById("searchText").value.trim().toLowerCase();
            const catFilter = document.getElementById("categoryFilter").value;
            let filtered = allBooks;
            
            // Filter by search text
            if (searchText) {
                filtered = filtered.filter(b => {
                    const fields = [b.title||"", b.author||"", b.bookNo||"", b.category||""]
                        .map(x => String(x).toLowerCase());
                    return fields.some(f => f.includes(searchText));
                });
            }
            
            // Filter by category
            if (catFilter) {
                filtered = filtered.filter(b => String(b.category).trim() === catFilter);
            }
            
            document.getElementById("totalCount").textContent = allBooks.length;
            document.getElementById("shownCount").textContent = filtered.length;
            
            filtered.forEach((b, idx) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${idx + 1}</td>
                    <td>${b.bookNo || ""}</td>
                    <td>${b.title || ""}</td>
                    <td>${b.author || ""}</td>
                    <td>${b.category || ""}</td>
                    <td class="small">${b._type}</td>
                    <td><button class="btn-primary btn-details" data-bookid="${b.bookNo}">Details</button></td>
                `;
                tbody.appendChild(tr);
            });
            
            // Setup detail button handlers
            tbody.querySelectorAll(".btn-details").forEach(btn => {
                btn.addEventListener("click", function() {
                    showBookDetails(this.getAttribute("data-bookid"));
                });
            });
        }

        function renderExtraTable() {
            const tbody = document.querySelector("#extraTable tbody");
            const seeBtn = document.getElementById("extraSeeMoreBtn");
            tbody.innerHTML = "";
            let rows = extraBooks;
            
            // Pagination/View more logic
            if (!extraExpanded && rows.length > 5) {
                rows = rows.slice(0, 5);
                seeBtn.style.display = "inline-block";
                seeBtn.textContent = "See more‚Ä¶";
            } else if (extraExpanded && extraBooks.length > 5) {
                seeBtn.style.display = "inline-block";
                seeBtn.textContent = "See less";
            } else {
                seeBtn.style.display = "none";
            }
            
            rows.forEach((b, index) => {
                const tr = document.createElement("tr");
                const realIndex = extraExpanded ? extraBooks.findIndex(item => item.bookNo === b.bookNo) : index;
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${b.bookNo || ""}</td>
                    <td>${b.title || ""}</td>
                    <td>${b.author || ""}</td>
                    <td>${b.category || ""}</td>
                    <td><button class="btn-danger btn-delete-extra" data-index="${realIndex}"><span class="icon">üóëÔ∏è</span> Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
            
            // Delete handler
            tbody.querySelectorAll(".btn-delete-extra").forEach(btn => {
                btn.addEventListener("click", function() {
                    const idx = parseInt(this.getAttribute("data-index"), 10);
                    if (!isNaN(idx) && confirm("Are you sure you want to delete this book?")) {
                        extraBooks.splice(idx, 1);
                        saveExtraBooks();
                        combineBooks();
                        renderBooksTable();
                        renderExtraTable();
                    }
                });
            });
        }

        function renderIssuesTable() {
            const tbody = document.querySelector("#issueTable tbody");
            const seeBtn = document.getElementById("issueSeeMoreBtn");
            tbody.innerHTML = "";
            const searchText = document.getElementById("issueSearch").value.trim().toLowerCase();
            let filtered = issues.slice().reverse(); // Show latest issues first
            
            if (searchText) {
                filtered = filtered.filter(it => {
                    const fields = [it.studentId||"", it.studentName||""]
                        .map(x => String(x).toLowerCase());
                    return fields.some(f => f.includes(searchText));
                });
            }

            const today = todayStr();
            let rows = filtered;
            
            // Pagination/View more logic
            if (!issuesExpanded && rows.length > 5) {
                rows = rows.slice(0, 5);
                seeBtn.style.display = "inline-block";
                seeBtn.textContent = "See more‚Ä¶";
            } else if (issuesExpanded && filtered.length > 5) {
                seeBtn.style.display = "inline-block";
                seeBtn.textContent = "See less";
            } else {
                seeBtn.style.display = "none";
            }

            rows.forEach((it, idx) => {
                const isOverdue = it.status === "Issued" && it.dueDate && (new Date(it.dueDate) < new Date(today));
                const statusText = isOverdue ? `<span class="error" style="font-weight:bold;">OVERDUE!</span>` : (it.status || "");
                const btnClass = isOverdue ? "btn-danger" : "btn-primary";
                
                let returnBtnHtml = "-";
                if (it.status === "Issued") {
                    returnBtnHtml = `
                        <button class='${btnClass} btn-return' data-id='${it.id}'><span class="icon">üîô</span> Return</button>
                        <button class='btn-primary btn-print-receipt' data-id='${it.id}'><span class="icon">üñ®</span> Print</button>
                    `;
                } else if (it.status === "Returned") {
                    returnBtnHtml = `<button class='btn-primary btn-print-receipt' data-id='${it.id}'><span class="icon">üñ®</span> Print Receipt</button>`;
                }

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${idx + 1}</td>
                    <td>${it.studentId || ""}</td>
                    <td>${it.studentName || ""}</td>
                    <td>${it.classSection || ""}</td>
                    <td>${it.bookNo || ""}</td>
                    <td>${it.title || ""}</td>
                    <td>${it.issueDate || ""}</td>
                    <td>${it.dueDate || ""}</td>
                    <td>${statusText}${it.returnDate ? "<br><span class='small'>Returned: " + it.returnDate + "</span>" : ""}</td>
                    <td>${returnBtnHtml}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Return handler
            tbody.querySelectorAll(".btn-return").forEach(btn => {
                btn.addEventListener("click", function() {
                    const id = this.getAttribute("data-id");
                    const idx = issues.findIndex(i => String(i.id) === String(id));
                    if (idx !== -1) {
                        issues[idx].status = "Returned";
                        issues[idx].returnDate = todayStr();
                        saveIssues();
                        renderIssuesTable();
                        generateReceipt(issues[idx]); // Print return receipt (New Feature)
                    }
                });
            });
            
            // Print Receipt handler
            tbody.querySelectorAll(".btn-print-receipt").forEach(btn => {
                btn.addEventListener("click", function() {
                    const id = this.getAttribute("data-id");
                    const issueItem = issues.find(i => String(i.id) === String(id));
                    if (issueItem) {
                        generateReceipt(issueItem);
                    }
                });
            });
        }
        
        // New Feature: Book Details Modal
        function showBookDetails(bookId) {
            const book = allBooks.find(b => String(b.bookNo).trim().toLowerCase() === String(bookId).trim().toLowerCase());
            const modal = document.getElementById("bookDetailModal");
            const historyBody = document.querySelector("#modalIssueHistory tbody");
            historyBody.innerHTML = "";

            if (book) {
                document.getElementById("modalTitle").textContent = book.title || "N/A";
                document.getElementById("modalBookNo").textContent = book.bookNo || "N/A";
                document.getElementById("modalAuthor").textContent = book.author || "N/A";
                document.getElementById("modalCategory").textContent = book.category || "N/A";
                document.getElementById("modalSource").textContent = book._type || "N/A";
                
                const bookHistory = issues
                    .filter(it => String(it.bookNo).trim().toLowerCase() === String(bookId).trim().toLowerCase())
                    .sort((a, b) => b.id - a.id); // Sort by latest first

                if (bookHistory.length === 0) {
                    historyBody.innerHTML = '<tr><td colspan="5">No issue history found for this book.</td></tr>';
                } else {
                    bookHistory.forEach(it => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>${it.studentId || ""}</td>
                            <td>${it.studentName || ""}</td>
                            <td>${it.issueDate || ""}</td>
                            <td>${it.dueDate || ""}</td>
                            <td>${it.status || ""}</td>
                        `;
                        historyBody.appendChild(tr);
                    });
                }

                modal.style.display = "block";
            } else {
                alert("Book not found!");
            }
        }

        // Setup Functions
        function setupAdmin() {
            // ... (Login/Logout/Add Book functions remain largely the same, just removing non-English text) ...
            const loginBtn = document.getElementById("loginBtn");
            const loginMsg = document.getElementById("loginMsg");
            const adminSection = document.getElementById("adminSection");
            const loginSection = document.getElementById("loginSection");
            const reportSection = document.getElementById("reportSection");
            const reportLoginSection = document.getElementById("reportLoginSection");
            
            loginBtn.addEventListener("click", () => {
                const pwd = document.getElementById("adminPassword").value;
                if (pwd === ADMIN_PASSWORD) {
                    loginMsg.textContent = "";
                    loginSection.style.display = "none";
                    adminSection.style.display = "block";
                    reportLoginSection.style.display = "none";
                    reportSection.style.display = "block";
                } else {
                    loginMsg.textContent = "Wrong password!";
                }
            });
            
            // Manually Add Book Handler
            document.getElementById("addBookBtn").addEventListener("click", () => {
                const bookNo = document.getElementById("adminBookNo").value.trim();
                const title = document.getElementById("adminTitle").value.trim();
                const author = document.getElementById("adminAuthor").value.trim();
                const category = document.getElementById("adminCategory").value.trim();
                const msg = document.getElementById("adminMsg");
                
                if (!bookNo || !title) {
                    msg.textContent = "Book ID and Title are required.";
                    msg.classList.add("error");
                    return;
                }
                
                // Check for duplicate Book ID
                const isDuplicate = allBooks.some(b => String(b.bookNo).trim().toLowerCase() === bookNo.toLowerCase());
                if (isDuplicate) {
                    msg.textContent = "Book ID already exists. Please use a unique ID.";
                    msg.classList.add("error");
                    return;
                }
                
                extraBooks.push({ serialNo:"", bookNo, title, author, category });
                saveExtraBooks();
                combineBooks();
                renderBooksTable();
                renderExtraTable();
                
                document.getElementById("adminBookNo").value = "";
                document.getElementById("adminTitle").value = "";
                document.getElementById("adminAuthor").value = "";
                document.getElementById("adminCategory").value = "";
                msg.textContent = "Book added successfully!";
                msg.classList.remove("error");
            });

            // See More/Less for Locally Added Books
            document.getElementById("extraSeeMoreBtn").addEventListener("click", () => {
                extraExpanded = !extraExpanded;
                renderExtraTable();
            });

            // See More/Less for Issues
            document.getElementById("issueSeeMoreBtn").addEventListener("click", () => {
                issuesExpanded = !issuesExpanded;
                renderIssuesTable();
            });
        }

        function setupBookIdAutoFill() {
            const idInput = document.getElementById("issueBookNo");
            const titleInput = document.getElementById("issueBookTitle");
            if (!idInput || !titleInput) return;

            function fillFromId() {
                const val = idInput.value.trim().toLowerCase();
                const found = allBooks.find(b => String(b.bookNo || "").trim().toLowerCase() === val);
                if (found) {
                    titleInput.value = found.title || "";
                } else {
                    titleInput.value = "";
                }
            }

            idInput.addEventListener("blur", fillFromId);
        }

        function setupStudentAutoFillForIssue() {
            const idInput = document.getElementById("studentId");
            const nameInput = document.getElementById("studentName");
            if (!idInput || !nameInput) return;

            function fillFromStudentId() {
                const val = idInput.value.trim().toLowerCase();
                const found = students.find(s => String(s.id || "").trim().toLowerCase() === val);
                if (found) {
                    nameInput.value = found.name || "";
                } else {
                    nameInput.value = "";
                }
            }

            idInput.addEventListener("blur", fillFromStudentId);
        }

        function setupIssueHandler() {
            const issueBtn = document.getElementById("issueBookBtn");
            const msg = document.getElementById("issueMsg");
            if (!issueBtn || !msg) return;
            
            issueBtn.addEventListener("click", () => {
                msg.textContent = "";
                msg.classList.remove("error");
                msg.style.color = "green";

                const bookNo = document.getElementById("issueBookNo").value.trim();
                const bookTitle = document.getElementById("issueBookTitle").value.trim();
                const studentId = document.getElementById("studentId").value.trim();
                const studentName = document.getElementById("studentName").value.trim();
                const classSection = document.getElementById("classSection").value.trim();
                let issueDate = document.getElementById("issueDate").value;
                let dueDate = document.getElementById("dueDate").value;

                // Validation checks
                if (!bookNo) {
                    msg.textContent = "‚ùå Please type Book ID.";
                    msg.classList.add("error"); msg.style.color = "red"; return;
                }
                if (!bookTitle) {
                    msg.textContent = "‚ùå Book Title not found. Check Book ID and press Tab/click outside.";
                    msg.classList.add("error"); msg.style.color = "red"; return;
                }
                
                // Check if book is already issued (New Feature)
                const isIssued = issues.some(i => String(i.bookNo).trim().toLowerCase() === bookNo.toLowerCase() && i.status === "Issued");
                if (isIssued) {
                     msg.textContent = "‚ùå This book is currently issued to another student. It must be returned first.";
                    msg.classList.add("error"); msg.style.color = "red"; return;
                }

                if (!studentId) {
                    msg.textContent = "‚ùå Please type Student ID.";
                    msg.classList.add("error"); msg.style.color = "red"; return;
                }
                if (!studentName) {
                    msg.textContent = "‚ùå Student Name not found. Check Student ID and press Tab/click outside. Also import IDs.";
                    msg.classList.add("error"); msg.style.color = "red"; return;
                }

                if (!issueDate) issueDate = todayStr();
                if (!dueDate)  dueDate  = addDays(issueDate, 21);
                
                // Save new issue record
                const newIssue = {
                    id: Date.now(),
                    bookNo,
                    title: bookTitle,
                    studentId,
                    studentName,
                    classSection,
                    issueDate,
                    dueDate,
                    status: "Issued",
                    returnDate: ""
                };
                issues.push(newIssue);
                saveIssues();
                renderIssuesTable();

                // Clear form
                document.getElementById("issueBookNo").value = "";
                document.getElementById("issueBookTitle").value = "";
                document.getElementById("studentId").value = "";
                document.getElementById("studentName").value = "";
                document.getElementById("classSection").value = "";
                document.getElementById("issueDate").value = todayStr();
                document.getElementById("dueDate").value = addDays(todayStr(), 21);

                msg.textContent = "‚úÖ Book issued successfully! Printing receipt...";
                msg.style.color = "green";
                generateReceipt(newIssue); // Print issue receipt (New Feature)
            });
        }

        // Excel Import Handlers (Book and Student)
        function setupExcelImport() {
            const btn = document.getElementById("importExcelBtn");
            const fileInput = document.getElementById("excelFile");
            const msg = document.getElementById("importMsg");
            
            btn.addEventListener("click", () => {
                // ... (Book Excel Import logic - remains the same) ...
                msg.textContent = "";
                msg.classList.remove("error");
                const file = fileInput.files[0];
                if (!file) {
                    msg.textContent = "Please choose an Excel file first.";
                    msg.classList.add("error");
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: "array" });
                        const firstSheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[firstSheetName];
                        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        if (!rows || rows.length < 2) {
                            msg.textContent = "Excel seems empty or has no data rows.";
                            msg.classList.add("error");
                            return;
                        }
                        const header = rows[0].map(h => String(h || "").trim().toUpperCase());
                        const idCandidates = ["BOOK NO", "BOOK ID", "ID"];
                        const titleCandidates = ["BOOK NAME", "TITLE", "BOOK"];
                        let idIndex = -1, titleIndex = -1;
                        header.forEach((h, i) => {
                            if (idIndex === -1 && idCandidates.includes(h)) idIndex = i;
                            if (titleIndex === -1 && titleCandidates.includes(h)) titleIndex = i;
                        });
                        if (idIndex === -1 || titleIndex === -1) {
                            msg.textContent = "Could not find Book ID and Book Name columns.";
                            msg.classList.add("error");
                            return;
                        }
                        let importedCount = 0;
                        for (let r = 1; r < rows.length; r++) {
                            const row = rows[r];
                            const idVal = row[idIndex];
                            const titleVal = row[titleIndex];
                            if (!idVal || !titleVal) continue;
                            
                            // Check for duplicate on import (New Feature)
                            const bookNo = String(idVal).trim();
                            const isDuplicate = allBooks.some(b => String(b.bookNo).trim().toLowerCase() === bookNo.toLowerCase());
                            if (isDuplicate) continue; 
                            
                            extraBooks.push({
                                serialNo:"",
                                bookNo: bookNo,
                                title: String(titleVal).trim(),
                                author:"",
                                category:""
                            });
                            importedCount++;
                        }
                        saveExtraBooks();
                        combineBooks();
                        renderBooksTable();
                        renderExtraTable();
                        msg.textContent = "Imported " + importedCount + " new books from Excel.";
                    } catch(err) {
                        console.error(err);
                        msg.textContent = "Error reading Excel file.";
                        msg.classList.add("error");
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            // Student Import Logic
            const studentBtn = document.getElementById("importStudentsBtn");
            const studentFileInput = document.getElementById("studentExcelFile");
            const studentMsg = document.getElementById("studentImportMsg");
            studentBtn.addEventListener("click", () => {
                // ... (Student ID Excel Import logic - remains the same) ...
                studentMsg.textContent = "";
                studentMsg.classList.remove("error");
                const file = studentFileInput.files[0];
                if (!file) {
                    studentMsg.textContent = "Please choose student ID Excel file first.";
                    studentMsg.classList.add("error");
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: "array" });
                        const firstSheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[firstSheetName];
                        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        if (!rows || rows.length === 0) {
                            studentMsg.textContent = "Excel seems empty.";
                            studentMsg.classList.add("error");
                            return;
                        }

                        const newStudents = [];
                        for (let r = 0; r < rows.length; r++) {
                            const row = rows[r];
                            const idVal = row[0];
                            const nameVal = row[1];
                            if (!idVal || !nameVal) continue;

                            const idStr = String(idVal).trim();
                            const nameStr = String(nameVal).trim();
                            const upperId = idStr.toUpperCase();
                            const upperName = nameStr.toUpperCase();

                            if (
                                upperId === "ID" ||
                                upperId === "STUDENT ID" ||
                                upperName === "NAME" ||
                                upperName === "STUDENT NAME"
                            ) {
                                continue;
                            }

                            newStudents.push({ id: idStr, name: nameStr });
                        }

                        students = newStudents;
                        saveStudents();
                        studentMsg.textContent = "Imported " + students.length + " student IDs (Column A = code, Column B = name).";
                    } catch(err) {
                        console.error(err);
                        studentMsg.textContent = "Error reading student Excel file.";
                        studentMsg.classList.add("error");
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        )}

        // New Feature: Export Functions
        function setupExportHandlers() {
            document.getElementById("exportAllBooksBtn").addEventListener("click", exportAllBooks);
            document.getElementById("exportIssuesBtn").addEventListener("click", exportIssueRecords);
        }

        function exportAllBooks() {
            if (allBooks.length === 0) {
                alert("No book data to export.");
                return;
            }
            const data = allBooks.map(b => ({
                'Book ID': b.bookNo,
                'Title': b.title,
                'Author': b.author,
                'Category': b.category,
                'Source': b._type
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "AllBooks");
            XLSX.writeFile(wb, "Library_All_Books_Export_" + todayStr() + ".xlsx");
        }

        function exportIssueRecords() {
            if (issues.length === 0) {
                alert("No issue records to export.");
                return;
            }
            const data = issues.map(i => ({
                'Transaction ID': i.id,
                'Student ID': i.studentId,
                'Student Name': i.studentName,
                'Class/Section': i.classSection,
                'Book ID': i.bookNo,
                'Title': i.title,
                'Issue Date': i.issueDate,
                'Due Date': i.dueDate,
                'Status': i.status,
                'Return Date': i.returnDate || ''
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "IssueRecords");
            XLSX.writeFile(wb, "Library_Issue_Records_Export_" + todayStr() + ".xlsx");
        }

        // Print Overdue Report (Existing logic, now a separate function)
        function printOverdueReport() {
            const today = todayStr();
            const overdue = issues.filter(it =>
                it.status === "Issued" &&
                it.dueDate &&
                (new Date(it.dueDate) < new Date(today))
            );

            // ... (HTML generation for print window - remains the same) ...
             const win = window.open("", "_blank");
            if (!win) return;

            let html = "<html><head><title>Overdue Books Report</title>";
            html += "<style>";
            html += "body{font-family:Arial,sans-serif;font-size:13px;margin:20px;}";
            html += "h2{text-align:center;margin-bottom:5px;}";
            html += "p{margin:4px 0;}";
            html += "table{width:100%;border-collapse:collapse;margin-top:10px;}";
            html += "th,td{border:1px solid #333;padding:5px;text-align:left;font-size:12px;}";
            html += "th{background:#eee;}";
            html += "</style></head><body>";
            html += "<h2>Overdue Books Report</h2>";
            html += "<p><strong>Date:</strong> " + today + "</p>";
            html += "<p><strong>Total Overdue:</strong> " + overdue.length + "</p>";

            if (overdue.length === 0) {
                html += "<p>No overdue books.</p>";
            } else {
                html += "<table><thead><tr>";
                html += "<th>#</th><th>Student ID</th><th>Name</th><th>Class</th><th>Book ID</th><th>Title</th><th>Issue Date</th><th>Due Date</th></tr></thead><tbody>";
                overdue.forEach((it, idx) => {
                    html += "<tr>";
                    html += "<td>" + (idx + 1) + "</td>";
                    html += "<td>" + (it.studentId || "") + "</td>";
                    html += "<td>" + (it.studentName || "") + "</td>";
                    html += "<td>" + (it.classSection || "") + "</td>";
                    html += "<td>" + (it.bookNo || "") + "</td>";
                    html += "<td>" + (it.title || "") + "</td>";
                    html += "<td>" + (it.issueDate || "") + "</td>";
                    html += "<td>" + (it.dueDate || "") + "</td>";
                    html += "</tr>";
                });
                html += "</tbody></table>";
            }

            html += "</body></html>";

            win.document.open();
            win.document.write(html);
            win.document.close();
            win.focus();
            win.print();
        }

        function setupTabs() {
            const buttons = document.querySelectorAll(".tab-btn");
            const tabs = document.querySelectorAll(".tab-content");
            buttons.forEach(btn => {
                btn.addEventListener("click", () => {
                    buttons.forEach(b => b.classList.remove("active"));
                    tabs.forEach(t => t.classList.remove("active"));
                    btn.classList.add("active");
                    const targetTab = document.getElementById(btn.getAttribute("data-tab"));
                    targetTab.classList.add("active");
                    
                    // Check admin status on tab switch (New Feature)
                    const isAdminLoggedIn = document.getElementById("adminSection").style.display !== 'none';
                    if (btn.getAttribute("data-tab") === "reportsTab") {
                        if (isAdminLoggedIn) {
                            document.getElementById("reportLoginSection").style.display = "none";
                            document.getElementById("reportSection").style.display = "block";
                        } else {
                            document.getElementById("reportLoginSection").style.display = "block";
                            document.getElementById("reportSection").style.display = "none";
                        }
                    }
                });
            });
        }

        // Modal close handler
        function setupModalHandler() {
            const modal = document.getElementById("bookDetailModal");
            const closeBtn = document.querySelector(".close-btn");
            
            closeBtn.addEventListener("click", () => {
                modal.style.display = "none";
            });
            window.addEventListener("click", (event) => {
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            });
        }


        // Initialization
        window.addEventListener("DOMContentLoaded", () => {
            setupTabs();
            setupAdmin();
            setupIssueHandler();
            setupExcelImport();
            setupStudentImport();
            setupExportHandlers(); // New Export Setup
            setupModalHandler(); // New Modal Setup
            
            loadExtraBooks();
            loadIssues();
            loadStudents();
            combineBooks();
            
            renderBooksTable();
            renderExtraTable();
            renderIssuesTable();
            
            // Initial Date setup for Issue tab
            const today = todayStr();
            const due = addDays(today, 21);
            const issueDateInput = document.getElementById("issueDate");
            const dueDateInput = document.getElementById("dueDate");
            if (issueDateInput) issueDateInput.value = today;
            if (dueDateInput) dueDateInput.value = due;
            
            // Event listeners for filtering
            document.getElementById("searchText").addEventListener("input", renderBooksTable);
            document.getElementById("categoryFilter").addEventListener("change", renderBooksTable);
            document.getElementById("clearFilters").addEventListener("click", () => {
                document.getElementById("searchText").value = "";
                document.getElementById("categoryFilter").value = "";
                renderBooksTable();
            });
            document.getElementById("issueSearch").addEventListener("input", renderIssuesTable);
            
            // Auto-fill setup
            setupBookIdAutoFill();
            setupStudentAutoFillForIssue();
            
            // Print button setup
            document.getElementById("printOverdueBtn").addEventListener("click", printOverdueReport);
        });
    </script>
</body>
</html>
